rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default: deny all access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Helper function to check if user is admin (non-anonymous auth)
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.firebase.sign_in_provider != 'anonymous';
    }
    
    // Helper function to check if user is anonymous
    function isAnonymous() {
      return request.auth != null && 
             request.auth.token.firebase.sign_in_provider == 'anonymous';
    }
    
    // Customers collection
    // Admin: full read/write access
    // Anonymous: can only read documents where they query by accessKey
    match /customers/{customerId} {
      // Admin users (non-anonymous) can read/write all customers
      allow read, write: if isAdmin();
      
      // Anonymous users can only read if the document's accessKey matches their query
      // This relies on the app querying with where("accessKey", "==", accessKey)
      // and Firestore returning only matching documents
      allow read: if isAnonymous();
    }
    
    // Transactions collection
    // Admin: full read/write access
    // Anonymous: read-only (for customer portal)
    match /transactions/{transactionId} {
      // Admin users can read/write
      allow read, write: if isAdmin();
      
      // Anonymous users can only read (customer portal needs to see transactions)
      allow read: if isAnonymous();
    }
    
    // Expenses collection - admin only (no anonymous access)
    match /expenses/{expenseId} {
      allow read, write: if isAdmin();
    }
  }
}
