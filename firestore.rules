rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default: deny all access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Helper function to check if user is admin (non-anonymous auth)
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.firebase.sign_in_provider != 'anonymous';
    }
    
    // Helper function to check if user is anonymous
    function isAnonymous() {
      return request.auth != null && 
             request.auth.token.firebase.sign_in_provider == 'anonymous';
    }
    
    // Customers collection
    // Admin: full read/write access
    // Customer portal (anonymous): only allow tightly scoped query by accessKey
    match /customers/{customerId} {
      // Admin users (non-anonymous) can read/write all customers
      allow read, write: if isAdmin();

      // Anonymous users may only LIST with an equality filter on accessKey and a tight limit.
      // This prevents enumerating the entire collection.
      allow list: if isAnonymous()
        && request.query.limit != null
        && request.query.limit <= 1
        && request.query.where('accessKey', '==', resource.data.accessKey);

      // Prevent direct reads by document ID for anonymous users.
      allow get: if false;
    }

    // Transactions collection
    // Admin: full read/write access
    // Customer portal (anonymous): only allow scoped queries by accessKey
    match /transactions/{transactionId} {
      // Admin users can read/write
      allow read, write: if isAdmin();

      // Anonymous users may only LIST with an equality filter on accessKey and a reasonable limit.
      allow list: if isAnonymous()
        && request.query.limit != null
        && request.query.limit <= 5000
        && request.query.where('accessKey', '==', resource.data.accessKey);

      // Prevent direct reads by document ID for anonymous users.
      allow get: if false;
    }

    // Expenses collection - admin only (no anonymous access)
    match /expenses/{expenseId} {
      allow read, write: if isAdmin();
    }
  }
}
