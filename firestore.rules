rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default: deny all access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Helper function to check if user is admin (non-anonymous auth)
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.firebase.sign_in_provider != 'anonymous';
    }
    
    // Helper function to check if user is anonymous
    function isAnonymous() {
      return request.auth != null && 
             request.auth.token.firebase.sign_in_provider == 'anonymous';
    }
    
    // Customers collection
    // Admin: full read/write access
    // Customer portal (anonymous): allow queries with limit, document-level accessKey check
    match /customers/{customerId} {
      // Admin users (non-anonymous) can read/write all customers
      allow read, write: if isAdmin();

      // Anonymous users may LIST with a tight limit.
      // Document-level validation ensures only documents with accessKey are returned.
      allow list: if isAnonymous()
        && request.query.limit != null
        && request.query.limit <= 1;

      // Document-level read: anonymous users can only read documents that have an accessKey
      // The app-layer query filters by accessKey, so only matching docs are returned
      allow read: if isAnonymous() && resource.data.accessKey != null;

      // Prevent direct reads by document ID for anonymous users.
      allow get: if false;
    }

    // Transactions collection
    // Admin: full read/write access
    // Customer portal (anonymous): allow queries with limit, document-level accessKey check
    match /transactions/{transactionId} {
      // Admin users can read/write
      allow read, write: if isAdmin();

      // Anonymous users may LIST with a reasonable limit.
      allow list: if isAnonymous()
        && request.query.limit != null
        && request.query.limit <= 5000;

      // Document-level read: anonymous users can only read documents that have an accessKey
      allow read: if isAnonymous() && resource.data.accessKey != null;

      // Prevent direct reads by document ID for anonymous users.
      allow get: if false;
    }

    // Expenses collection - admin only (no anonymous access)
    match /expenses/{expenseId} {
      allow read, write: if isAdmin();
    }
  }
}
