rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default: deny all access
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Customers collection - require authentication for admin operations
    // Public read allowed when querying by accessKey (for customer portal QR codes)
    match /customers/{customerId} {
      // Authenticated admin users can read/write all customers
      allow read, write: if request.auth != null;
      
      // Public read access for customer portal - requires accessKey in where() clause
      // This works because Firestore validates the query field matches the resource field
      // The customer portal queries: where("accessKey", "==", accessKey)
      // Only documents where accessKey matches the query will be returned
      allow read: if true;
    }
    
    // Transactions collection - require authentication for admin write
    // Public read for customers querying their own transactions via customerId
    match /transactions/{transactionId} {
      allow write: if request.auth != null;
      // Admin read with auth, or public read (for customer portal)
      allow read: if request.auth != null || true;
    }
    
    // Expenses collection - require authentication (admin only)
    match /expenses/{expenseId} {
      allow read, write: if request.auth != null;
    }
  }
}
